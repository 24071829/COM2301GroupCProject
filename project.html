<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>School Lost & Found System (Offline)</title>
  <style>
    /* --- Basic layout CSS --- */
    :root{--primary:#1976d2;--muted:#f3f4f6;--card:#ffffff;--accent:#667eea}
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, Arial, sans-serif;background:#eef2ff;margin:0;color:#1f2937}
    .container{max-width:1100px;margin:28px auto;padding:18px}
    .header{text-align:center;margin-bottom:18px}
    .header h1{margin:0;font-size:1.8rem;color:var(--primary)}
    .header p{margin:6px 0;color:#555}
    .card{background:var(--card);border-radius:10px;padding:16px;box-shadow:0 6px 18px rgba(20,20,60,.06);margin-bottom:14px}
    .nav-tabs{display:flex;gap:8px;flex-wrap:wrap}
    .nav-tab{padding:8px 12px;border-radius:8px;border:1px solid #e6eefc;background:linear-gradient(180deg,#fff,#f6fbff);cursor:pointer}
    .nav-tab.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .form-group{margin-bottom:10px}
    label{display:block;font-weight:600;margin-bottom:6px;font-size:.95rem}
    input[type="text"],input[type="email"],input[type="password"],input[type="date"],select,textarea{
      width:100%;padding:8px;border-radius:8px;border:1px solid #dbe7ff;background:#fff
    }
    textarea{resize:vertical;min-height:72px}
    .btn{background:var(--primary);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn-secondary{background:#6b7280;color:#fff;border:0;padding:7px 10px;border-radius:8px;cursor:pointer}
    .items-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;margin-top:12px}
    .item-card{background:#fff;border-radius:8px;padding:12px;border:1px solid #f0f6ff}
    .item-status{font-weight:700;font-size:.78rem;padding:4px 8px;border-radius:999px;display:inline-block;margin-bottom:8px}
    .status-lost{background:#fff1f0;color:#b91c1c}
    .status-found{background:#ecfdf5;color:#166534}
    .status-claimed{background:#eff6ff;color:#1e40af}
    .small{font-size:.86rem;color:#4b5563}
    .badge{display:inline-block;background:#ef4444;color:#fff;padding:4px 8px;border-radius:999px;font-weight:700}
    .top-right{float:right}
    .flex{display:flex;gap:8px;align-items:center}
    .hidden{display:none}
    .notify-badge{background:#ef4444;color:#fff;padding:3px 7px;border-radius:999px;font-weight:700;margin-left:6px;font-size:.8rem}
    a.link{color:var(--accent);cursor:pointer;text-decoration:underline}
    /* responsive */
    @media (max-width:720px){.container{margin:12px;padding:12px}}
  </style>
</head>
<body>
  <div class="container">

    <div class="header">
      <h1>üè´ School Lost & Found</h1>
      <p>Report, search, and reclaim items easily</p>
    </div>

    <!-- LOGIN AND REGISTRATION -->
    <div id="authCard" class="card">
      <div class="nav-tabs" style="margin-bottom:12px">
        <button class="nav-tab active" onclick="showAuthTab(event,'login')">Login</button>
        <button class="nav-tab" onclick="showAuthTab(event,'register')">Register</button>
      </div> 

      <div id="loginTab">
        <form id="loginForm">
          <div class="form-group"><label>Email or ID</label><input id="loginEmail" type="text" required></div>
          <div class="form-group"><label>Password</label><input id="loginPassword" type="password" required></div>
          <div class="flex"><button class="btn" type="submit">Login</button></div>
        </form>
      </div>

      <div id="registerTab" class="hidden">
        <form id="registerForm">
          <div class="form-group"><label>Full name</label><input id="regName" type="text" required></div>
          <div class="form-group"><label>Email</label><input id="regEmail" type="email" required></div>
          <div class="form-group"><label>Student/Staff ID</label><input id="regId" type="text" required></div>
          <div class="form-group"><label>Role</label>
            <select id="regRole" required>
              <option value="">Select role</option>
              <option value="student">Student</option>
              <option value="staff">Staff</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="form-group"><label>Password</label><input id="regPassword" type="password" required></div>
          <div class="flex"><button class="btn" type="submit">Register</button></div>
        </form>
      </div>
    </div>

    <!-- MAIN INTERFACE AFTER LOGIN -->
    <div id="appCard" class="card hidden">
      <div style="display:flex;align-items:center">
        <div>
          <strong>Welcome, <span id="currentUserName"></span></strong>
          <div class="small" id="currentUserRole"></div>
        </div>

        <div style="margin-left:auto" class="flex">
          <button class="btn-secondary" onclick="logout()">Logout</button>
        </div> 
      </div>

      <hr style="margin:12px 0">

      <div class="nav-tabs" style="margin-bottom:12px">
        <button class="nav-tab active" onclick="showTab(event,'browse')">Browse</button>
        <button class="nav-tab" onclick="showTab(event,'reportLost')">Report Lost</button>
        <button class="nav-tab" onclick="showTab(event,'reportFound')">Report Found</button>
        <button class="nav-tab" onclick="showTab(event,'myReports')">My Reports</button>
        <button class="nav-tab" id="notifyTabButton" onclick="showTab(event,'notifications')">Notifications <span id="notifyBadge" class="notify-badge hidden">0</span></button>
      </div>

      <!-- TAB: BROWSE -->
      <div id="browseTab" class="tab-content">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
          <input id="searchInput" type="text" placeholder="Search by name or category..." style="flex:1;padding:8px;border-radius:8px;border:1px solid #dbeafe" oninput="renderBrowse()" />
          <select id="statusFilter" style="padding:8px;border-radius:8px;border:1px solid #dbeafe" onchange="renderBrowse()">
            <option value="">All</option><option value="lost">Lost</option><option value="found">Found</option><option value="claimed">Claimed</option>
          </select>
          <button class="btn" onclick="renderBrowse()">Refresh</button>
        </div>
        <div id="itemsContainer" class="items-grid"></div>
      </div>

      <!-- TAB: REPORT LOST -->
      <div id="reportLostTab" class="tab-content hidden">
        <form id="lostForm">
          <div class="form-group"><label>Item name</label><input id="lost_name" required></div>
          <div class="form-group"><label>Category</label><input id="lost_category" required></div>
          <div class="form-group"><label>Description</label><textarea id="lost_description"></textarea></div>
          <div class="form-group"><label>Date lost</label><input id="lost_date" type="date" required></div>
          <div class="flex"><button class="btn" type="submit">Report Lost Item</button></div>
        </form>
      </div>

      <!-- TAB: REPORT FOUND -->
      <div id="reportFoundTab" class="tab-content hidden">
        <form id="foundForm">
          <div class="form-group"><label>Item name</label><input id="found_name" required></div>
          <div class="form-group"><label>Category</label><input id="found_category" required></div>
          <div class="form-group"><label>Description</label><textarea id="found_description"></textarea></div>
          <div class="form-group"><label>Date found</label><input id="found_date" type="date" required></div>
          <div class="flex"><button class="btn" type="submit">Report Found Item</button></div>
        </form>
      </div>

      <!-- TAB: MY REPORTS -->
      <div id="myReportsTab" class="tab-content hidden">
        <h3 class="small">Your Reports</h3>
        <div id="myReportsContainer" class="items-grid"></div>
      </div>

      <!-- TAB: NOTIFICATIONS -->
      <div id="notificationsTab" class="tab-content hidden">
        <h3 class="small">Notifications (possible matches)</h3>
        <div id="notificationsContainer"></div>
      </div>
    </div>

  </div>

<script>

(function() {
  // App state . FOR DATA TO BE STORED ON LOCALSTORAGE SO THAT IT WORKS OFFLINE
  let users = JSON.parse(localStorage.getItem('lostFoundUsers') || '[]');
  let items = JSON.parse(localStorage.getItem('lostFoundItems') || '[]');
  let notifications = JSON.parse(localStorage.getItem('lostFoundNotifications') || '[]');
  let currentUser = null;

  // ---------- Helper FUNCTION----------
  function saveUsers(){ localStorage.setItem('lostFoundUsers', JSON.stringify(users)); }
  function saveItems(){ localStorage.setItem('lostFoundItems', JSON.stringify(items)); }
  function saveNotifications(){ localStorage.setItem('lostFoundNotifications', JSON.stringify(notifications)); }

  function uid(){ return Date.now() + Math.floor(Math.random()*999); }
  function todayISO(){ return new Date().toISOString().split('T')[0]; }

  // ---------- Sample data (first run) ----------
  function ensureSampleUsers(){
    if(users.length === 0){
      users.push({name:"Admin", email:"admin@school.edu", id:"A001", role:"admin", password:"admin123"});
      users.push({name:"John Doe", email:"john.doe@school.edu", id:"S001", role:"student", password:"student123"});
      users.push({name:"Jane Smith", email:"jane.smith@school.edu", id:"T001", role:"staff", password:"staff123"});
      saveUsers();
    }
  }

  // ---------- UI utility ----------
  function el(id){ return document.getElementById(id); }
  function showAuthTab(ev, tab){
    el('loginTab').classList.toggle('hidden', tab!=='login');
    el('registerTab').classList.toggle('hidden', tab!=='register');
    const tabs = document.querySelectorAll('#authCard .nav-tab'); tabs.forEach(t=>t.classList.remove('active'));
    if(ev && ev.target) ev.target.classList.add('active');
  }
  function showTab(ev, tab){
    const tabIds = {browse:'browseTab',reportLost:'reportLostTab',reportFound:'reportFoundTab',myReports:'myReportsTab',notifications:'notificationsTab'};
    Object.values(tabIds).forEach(id => el(id).classList.add('hidden'));
    el(tabIds[tab]).classList.remove('hidden');
    // highlight nav tabs
    const navs = document.querySelectorAll('#appCard .nav-tab'); navs.forEach(n=>n.classList.remove('active'));
    if(ev && ev.target) ev.target.classList.add('active');
    // refresh contents for some tabs
    if(tab==='browse') renderBrowse();
    if(tab==='myReports') renderMyReports();
    if(tab==='notifications') renderNotifications();
  }

  function showAppFor(user){
    currentUser = user;
    localStorage.setItem('currentUser', JSON.stringify(user));
    el('authCard').classList.add('hidden');
    el('appCard').classList.remove('hidden');
    el('currentUserName').textContent = user.name;
    el('currentUserRole').textContent = user.role.charAt(0).toUpperCase()+user.role.slice(1);
    renderBrowse();
    renderNotifyBadge();
  }

  function logout(){
    currentUser = null;
    localStorage.removeItem('currentUser');
    el('authCard').classList.remove('hidden');
    el('appCard').classList.add('hidden');
  }

  // ---------- Render functions ----------
  function renderBrowse(){
    const container = el('itemsContainer');
    container.innerHTML = '';
    const q = (el('searchInput') && el('searchInput').value || '').toLowerCase();
    const statusFilter = (el('statusFilter') && el('statusFilter').value) || '';
    const filtered = items.filter(it => {
      if(statusFilter && (statusFilter !== it.status && !(statusFilter==='claimed' && it.status==='claimed'))) return false;
      if(!q) return true;
      return it.name.toLowerCase().includes(q) || it.category.toLowerCase().includes(q) || (it.description||'').toLowerCase().includes(q);
    }).sort((a,b)=>b.id - a.id);
    if(filtered.length ===0){ container.innerHTML = '<div class="small">No items to show.</div>'; return; }
    filtered.forEach(it => container.appendChild(itemCardElement(it)));
  }

  function renderMyReports(){
    const container = el('myReportsContainer');
    container.innerHTML = '';
    const mine = items.filter(it => currentUser && it.userId === currentUser.id).sort((a,b)=>b.id - a.id);
    if(mine.length===0){ container.innerHTML = '<div class="small">You have no reports yet.</div>'; return; }
    mine.forEach(it => container.appendChild(itemCardElement(it)));
  }

  function renderNotifications(){
    const container = el('notificationsContainer');
    container.innerHTML = '';
    if(!currentUser){ container.innerHTML='<div class="small">No user.</div>'; return; }
    const mine = notifications.filter(n => n.forUserId === currentUser.id).sort((a,b)=>b.createdAt - a.createdAt);
    if(mine.length===0){ container.innerHTML = '<div class="small">No notifications.</div>'; el('notifyBadge').classList.add('hidden'); return; }
    mine.forEach(n => {
      const div = document.createElement('div');
      div.className = 'card';
      div.style.marginBottom = '10px';
      const seenMark = n.seen ? '' : '<span class="badge">NEW</span> ';
      const created = new Date(n.createdAt).toLocaleString();
      // build matched items display
      const matchesHtml = n.matches.map(id => {
        const itm = items.find(x=>x.id===id);
        if(itm) return `<div style="margin:6px 0"><b>${itm.name}</b> ‚Äî ${itm.type.toUpperCase()} (${itm.category}) reported by ${itm.reporter}</div>`;
        return `<div class="small">Item #${id} (missing)</div>`;
      }).join('');
      div.innerHTML = `
        <div class="small">${seenMark}<strong>${n.title}</strong> <span style="float:right" class="small">${created}</span></div>
        <div style="margin-top:8px">${n.message}</div>
        <div style="margin-top:8px">${matchesHtml}</div>
        <div style="margin-top:10px" class="flex">
          <button class="btn" onclick="markNotificationSeen(${n.id})">Mark as read</button>
          <button class="btn-secondary" onclick="dismissNotification(${n.id})">Dismiss</button>
          <button class="btn-secondary" onclick="jumpToMatched(${n.id})">View matches in Browse</button>
        </div>
      `;
      container.appendChild(div);
    });
  }

  function renderNotifyBadge(){
    if(!currentUser){ el('notifyBadge').classList.add('hidden'); return; }
    const count = notifications.filter(n => n.forUserId === currentUser.id && !n.seen).length;
    const badge = el('notifyBadge');
    if(count>0){ badge.textContent = count; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); }
  }

  // ---------- item card creation ----------
  function itemCardElement(it){
    const div = document.createElement('div');
    div.className = 'item-card';
    const statusClass = it.status==='claimed' ? 'status-claimed' : (it.type==='lost' ? 'status-lost' : 'status-found');
    const statusText = it.status==='claimed' ? 'CLAIMED' : it.type.toUpperCase();
    div.innerHTML = `
      <div class="item-status ${statusClass}">${statusText}</div>
      <h3 style="margin:.3rem 0">${it.name}</h3>
      <div class="small"><b>Category:</b> ${it.category}</div>
      <div class="small"><b>Date:</b> ${it.date}</div>
      <div class="small" style="margin-top:6px">${it.description || ''}</div>
      <div class="small" style="margin-top:8px"><b>Reported by:</b> ${it.reporter}</div>
      <div style="margin-top:10px" class="flex">
        ${ (it.status !== 'claimed' && currentUser && (currentUser.id === it.userId || currentUser.role === 'admin')) ? `<button class="btn-secondary" onclick="markItemClaimed(${it.id})">Mark as Claimed</button>` : ''}
        ${ (it.status !== 'claimed' && currentUser && currentUser.id !== it.userId) ? `<button class="btn" onclick="createClaim(${it.id})">I want to claim</button>` : '' }
      </div>
    `;
    return div;
  }

  // ---------- actions ----------
  function markItemClaimed(id){
    items = items.map(it => it.id === id ? {...it, status:'claimed'} : it);
    saveItems();
    renderBrowse(); renderMyReports(); // update views
  }

  function createClaim(itemId){
    // simple flow: notify item's reporter and admin (if any)
    const item = items.find(it => it.id === itemId);
    if(!item){ alert('Item not found'); return; }
    // create a notification for the item's reporter
    const note = {
      id: uid(),
      forUserId: item.userId,
      createdAt: Date.now(),
      seen: false,
      title: `Someone claims your "${item.name}"`,
      message: `${currentUser.name} (ID: ${currentUser.id}) says they want to claim "${item.name}". Please contact them to verify ownership.`,
      matches: [itemId]
    };
    notifications.push(note);
    saveNotifications();
    renderNotifyBadge();
    alert('Claim notified to the reporter. Admins can be notified too.');
  }

  // ---------- matching logic & notifications ----------
  function checkMatchesFor(newItem){
    // find potential matches: opposite type, not claimed, name or category overlap (case-insens)
    const lowerName = (newItem.name||'').toLowerCase();
    const lowerCat = (newItem.category||'').toLowerCase();
    const oppositeType = newItem.type === 'lost' ? 'found' : 'lost';
    const matches = items.filter(it =>
      it.type === oppositeType && it.status !== 'claimed' && it.id !== newItem.id &&
      (
        (it.name || '').toLowerCase().includes(lowerName) ||
        lowerName.includes((it.name||'').toLowerCase()) ||
        (it.category || '').toLowerCase().includes(lowerCat) ||
        lowerCat.includes((it.category||'').toLowerCase())
      )
    ).map(it=>it.id);

    if(matches.length>0){
      // 1) notify the reporter (current user)
      const n1 = {
        id: uid(),
        forUserId: newItem.userId,
        createdAt: Date.now(),
        seen: false,
        title: `Possible matches for "${newItem.name}"`,
        message: `We found ${matches.length} potential match(es) for the item you reported.`,
        matches: matches
      };
      notifications.push(n1);

      // 2) notify each matched item's reporter
      matches.forEach(mid => {
        const matchedItem = items.find(x => x.id === mid);
        if(matchedItem){
          notifications.push({
            id: uid(),
            forUserId: matchedItem.userId,
            createdAt: Date.now(),
            seen: false,
            title: `Your reported item "${matchedItem.name}" may match a new report`,
            message: `${newItem.reporter} reported "${newItem.name}" which may match your item. Please check Browse / Notifications.`,
            matches: [newItem.id, mid]
          });
        }
      });

      saveNotifications();
      renderNotifyBadge();
      alert(`üîî Possible match detected! ${matches.length} potential match(es). Check the Notifications tab.`);
    }
  }

  // notification controls
  window.markNotificationSeen = function(nid){
    notifications = notifications.map(n => n.id === nid ? {...n, seen:true} : n);
    saveNotifications(); renderNotifications(); renderNotifyBadge();
  };
  window.dismissNotification = function(nid){
    notifications = notifications.filter(n => n.id !== nid);
    saveNotifications(); renderNotifications(); renderNotifyBadge();
  };
  window.jumpToMatched = function(nid){
    const n = notifications.find(x=>x.id===nid);
    if(!n) return;
    // show browse and highlight (simple: switch to browse; search for first match)
    showTab(null,'browse');
    if(n.matches && n.matches.length>0){
      // set search to first matched item name to help user locate it
      const first = items.find(it => it.id === n.matches[0]);
      if(first){ el('searchInput').value = first.name; renderBrowse(); }
    }
  };

  // ---------- register/login handlers ----------
  function registerUser(ev){
    ev.preventDefault();
    const name = el('regName').value.trim();
    const email = el('regEmail').value.trim().toLowerCase();
    const id = el('regId').value.trim();
    const role = el('regRole').value;
    const pw = el('regPassword').value;
    if(!name||!email||!id||!role||!pw){ alert('Please complete the form.'); return; }
    if(users.find(u => u.email === email || u.id === id)){ alert('A user with this email or ID already exists'); return; }
    const u = { name, email, id, role, password: pw };
    users.push(u); saveUsers();
    alert('Registered successfully ‚Äî please login.');
    showAuthTab(null,'login');
    ev.target.reset();
  }

  function loginUser(ev){
    ev.preventDefault();
    const ident = el('loginEmail').value.trim().toLowerCase();
    const pw = el('loginPassword').value;
    const u = users.find(user => (user.email === ident || user.id === ident) && user.password === pw);
    if(!u){ alert('Invalid credentials ‚Äî try sample accounts or register.'); return; }
    showAppFor(u);
  }

  // ---------- item reporting handlers ----------
  function submitLost(ev){
    ev.preventDefault();
    if(!currentUser){ alert('Please login first.'); return; }
    const name = el('lost_name').value.trim();
    const category = el('lost_category').value.trim();
    const description = el('lost_description').value.trim();
    const date = el('lost_date').value || todayISO();
    if(!name || !category || !date){ alert('Please fill required fields'); return; }
    const it = { id: uid(), type:'lost', name, category, description, date, reporter: currentUser.name, userId: currentUser.id, status:'active' };
    items.push(it); saveItems();
    // check matches and create notifications
    checkMatchesFor(it);
    alert('Lost item reported.');
    ev.target.reset();
    renderBrowse(); renderMyReports();
  }

  function submitFound(ev){
    ev.preventDefault();
    if(!currentUser){ alert('Please login first.'); return; }
    const name = el('found_name').value.trim();
    const category = el('found_category').value.trim();
    const description = el('found_description').value.trim();
    const date = el('found_date').value || todayISO();
    if(!name || !category || !date){ alert('Please fill required fields'); return; }
    const it = { id: uid(), type:'found', name, category, description, date, reporter: currentUser.name, userId: currentUser.id, status:'active' };
    items.push(it); saveItems();
    checkMatchesFor(it);
    alert('Found item reported.');
    ev.target.reset();
    renderBrowse(); renderMyReports();
  }

  // ---------- claims & contact ----------
  // createClaim and markItemClaimed defined earlier 
  window.createClaim = function(itemId){ // wrapper so card onclick can call global
    const it = items.find(x=>x.id===itemId);
    if(!it){ alert('Item not found'); return; }
    if(!currentUser){ alert('Please login to claim'); return; }
    // notify reporter (simple: add notification)
    const note = {
      id: uid(),
      forUserId: it.userId,
      createdAt: Date.now(),
      seen:false,
      title: `Claim attempt for "${it.name}"`,
      message: `${currentUser.name} (ID: ${currentUser.id}) submitted a claim for "${it.name}". Please confirm with them.`,
      matches:[it.id]
    };
    notifications.push(note); saveNotifications(); renderNotifyBadge();
    alert('Claim sent to reporter via notification.');
  };

  window.markItemClaimed = function(itemId){ markItemClaimed(itemId); };

  // ---------- notifications badge ----------
  function renderNotifyBadge(){ if(!currentUser){ el('notifyBadge').classList.add('hidden'); return; } const count = notifications.filter(n => n.forUserId === currentUser.id && !n.seen).length; const badge = el('notifyBadge'); if(count>0){ badge.textContent = count; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); } }

  // ---------- init ----------
  function init(){
    ensureSampleUsers();
    // Hooks
    document.getElementById('registerForm').addEventListener('submit', registerUser);
    document.getElementById('loginForm').addEventListener('submit', loginUser);
    document.getElementById('lostForm').addEventListener('submit', submitLost);
    document.getElementById('foundForm').addEventListener('submit', submitFound);
    // Set default dates
    el('lost_date').value = todayISO();
    el('found_date').value = todayISO();
    // Auto login if saved
    const saved = localStorage.getItem('currentUser');
    if(saved){ currentUser = JSON.parse(saved); showAppFor(currentUser); }
    // initial render
    renderBrowse();
    renderNotifyBadge();
  }

  // Expose some actions to global (used by HTML inline onclick)
  window.logout = logout;
  window.showAuthTab = showAuthTab;
  window.showTab = showTab;
  window.dismissNotification = function(id){ notifications = notifications.filter(n=>n.id!==id); saveNotifications(); renderNotifications(); renderNotifyBadge(); };
  window.markNotificationSeen = function(id){ notifications = notifications.map(n=>n.id===id?{...n,seen:true}:n); saveNotifications(); renderNotifications(); renderNotifyBadge(); };
  window.jumpToMatched = function(id){ const n = notifications.find(x=>x.id===id); if(!n) return; showTab(null,'browse'); if(n.matches && n.matches.length>0){ const first = items.find(it=>it.id===n.matches[0]); if(first){ el('searchInput').value = first.name; renderBrowse(); } } };

  // forStarting app
  init();
})();
</script>
</body>
</html>
